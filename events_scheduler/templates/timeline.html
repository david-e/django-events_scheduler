{% load admin_static %}{% load i18n %}
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<head>
    <meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <title>{{ TITLE|default:"Timeline" }}</title>

    <script src='{% static "js/dhtmlx/dhtmlxscheduler.js" %}' type="text/javascript" charset="utf-8"></script>
    <script src='{% static "js/dhtmlx/ext/dhtmlxscheduler_timeline.js"%}' type="text/javascript"
            charset="utf-8"></script>
    <script src='{% static "js/dhtmlx/ext/dhtmlxscheduler_treetimeline.js"%}' type="text/javascript"
            charset="utf-8"></script>

    <link rel='stylesheet' type='text/css' href='{% static "css/dhtmlx/dhtmlxscheduler.css" %}'>

    <style type="text/css" media="screen">
        html, body {
            margin: 0px;
            padding: 0px;
            height: 100%;
            overflow: hidden;
        }

    </style>

    <script type="text/javascript" charset="utf-8">
        function init() {

            scheduler.locale.labels.timeline_tab = "Timeline";
            scheduler.locale.labels.section_custom = "Section";
            scheduler.config.details_on_create = true;
            scheduler.config.details_on_dblclick = true;
            scheduler.config.xml_date = "%Y-%m-%d %H:%i";


            //===============
            //Configuration
            //===============

            var elements = {{ etypes|safe }};


            var durations = {
                day:24 * 60 * 60 * 1000,
                hour:60 * 60 * 1000,
                minute:60 * 1000
            };

            var get_formatted_duration = function (start, end) {
                var diff = end - start;

                var days = Math.floor(diff / durations.day);
                diff -= days * durations.day;
                var hours = Math.floor(diff / durations.hour);
                diff -= hours * durations.hour;
                var minutes = Math.floor(diff / durations.minute);

                var results = [];
                if (days) results.push(days + " days");
                if (hours) results.push(hours + " hours");
                if (minutes) results.push(minutes + " minutes");
                return results.join(", ");
            };


            var resize_date_format = scheduler.date.date_to_str(scheduler.config.hour_date);

            scheduler.templates.event_bar_text = function (start, end, event) {
                var state = scheduler.getState();
                if (state.drag_id == event.id) {
                    return resize_date_format(start) + " - " + resize_date_format(end) + " (" + get_formatted_duration(start, end) + ")";
                }
                return event.text; // default
            };


            scheduler.createTimelineView({
                section_autoheight:false,
                name:"timeline",
                x_unit:"minute",
                x_date:"%H:%i",
                x_step:30,
                x_size:24,
                x_start:14,
                x_length:48,
                y_unit:elements,
                y_property:"section_id",
                render:"tree",
                folder_dy:20,
                dy: 50,
                event_dy: 'full'
            });


            //===============
            //Data loading
            //===============
            scheduler.config.lightbox.sections = [
                {name:"description", height:130, map_to:"text", type:"textarea", focus:true},
                {name:"custom", height:23, type:"timeline", options:null, map_to:"section_id" },
                //type should be the same as name of the tab
                {name:"time", height:72, type:"time", map_to:"auto"}
            ]

            scheduler.init('events_scheduler', new Date(), "timeline");
            scheduler.parse({{ events|safe }}, "json");

        }
    </script>
</head>
<body onload="init();">
<div id="events_scheduler" class="dhx_cal_container" style='width:100%; height:100%;'>
    <div class="dhx_cal_navline">
        <div class="dhx_cal_prev_button">&nbsp;</div>
        <div class="dhx_cal_next_button">&nbsp;</div>
        <div class="dhx_cal_today_button"></div>
        <div class="dhx_cal_date"></div>
        <div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div>
        <div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div>
        <div class="dhx_cal_tab" name="timeline_tab" style="right:280px;"></div>
        <div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div>
    </div>
    <div class="dhx_cal_header">
    </div>
    <div class="dhx_cal_data">
    </div>
</div>
</body>
